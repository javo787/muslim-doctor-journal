<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Muslim Doctor</title>
    
    <!-- PWA MANIFEST (Auto-Generated) -->
    <link rel="manifest" id="manifest-placeholder">

    <!-- IOS SETTINGS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Muslim Doctor">
    <meta name="theme-color" content="#047857">

    <!-- ICONS -->
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/3063/3063176.png">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3063/3063176.png">

    <!-- LIBRARIES -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; }
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: env(safe-area-inset-top); }
        @keyframes pulse-custom { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        .animate-pulse-custom { animation: pulse-custom 2s infinite; }
        .slide-in { animation: slideIn 0.3s ease-out forwards; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .confetti { position: fixed; top: 0; width: 10px; height: 10px; background-color: #f00; animation: confetti-fall 4s linear infinite; z-index: 60; }
        @keyframes confetti-fall { 0% { transform: translateY(-100vh) rotate(0deg); } 100% { transform: translateY(100vh) rotate(720deg); } }
        .chat-bubble-ai { background: #f0fdf4; border: 1px solid #dcfce7; color: #166534; border-radius: 12px 12px 12px 0; padding: 12px; margin-bottom: 8px; }
        .chat-bubble-user { background: #e0e7ff; border: 1px solid #c7d2fe; color: #3730a3; border-radius: 12px 12px 0 12px; padding: 12px; margin-bottom: 8px; margin-left: auto; max-width: 85%; }
        @keyframes bounce-custom { 0%, 100% { transform: translateY(-5%); } 50% { transform: none; } }
        .animate-bounce-custom { animation: bounce-custom 1s infinite; }
    </style>

    <!-- DYNAMIC MANIFEST SCRIPT -->
    <script>
        const manifest = {
            "name": "Muslim Doctor",
            "short_name": "Doctor",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#ffffff",
            "theme_color": "#047857",
            "icons": [{
                "src": "https://cdn-icons-png.flaticon.com/512/3063/3063176.png",
                "sizes": "512x512",
                "type": "image/png"
            }]
        };
        const stringManifest = JSON.stringify(manifest);
        const blob = new Blob([stringManifest], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(blob);
        document.querySelector('#manifest-placeholder').setAttribute('href', manifestURL);
    </script>
</head>
<body class="bg-gray-50 text-slate-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const Icon = ({ name, size = 24, className = "" }) => {
            const iconRef = useRef(null);
            useEffect(() => { if (window.lucide) window.lucide.createIcons({ root: iconRef.current, name, attrs: { width: size, height: size, class: className } }); }, [name, size, className]);
            return <i ref={iconRef} data-lucide={name} className={className}></i>;
        };

        const styles = {
            critical: "bg-gray-900 text-red-500 transition-colors duration-700",
            stable: "bg-slate-50 text-slate-800 transition-colors duration-700",
            legend: "bg-amber-50 text-amber-900 transition-colors duration-700",
            cardCritical: "bg-gray-800 border-red-900 shadow text-red-100",
            cardStable: "bg-white border-slate-200 shadow-sm text-slate-800",
            cardLegend: "bg-white border-amber-300 shadow text-amber-900",
            inputCritical: "bg-gray-900 border-red-800 text-red-200 placeholder-red-700",
            inputStable: "bg-white border-slate-300 text-slate-800 placeholder-slate-400",
            inputLegend: "bg-amber-50/50 border-amber-200 text-amber-900 placeholder-amber-400"
        };

        const dailyQuotes = ["Раббий зидни илмам.", "Сабр билан ғалаба келади.", "Аллоҳ собирларни яхши кўради.", "Бугун — имтиҳон. Эртага — ҳисоб.", "Илм — ибодатдир."];
        const defaultGoalsData = { firstAid: 15, uWorld: 40, anki: 25, prayers: 5 };
        const defaultSettingsData = { smallReward: "+50с-ди ҳалоладинг😅", bigReward: "Тоғга чиқиш", punishment: "50 сўм эҳсон", apiKey: "", enableNotifications: false };
        const defaultDailyData = {
            firstAidDone: 0, uWorldDone: 0, ankiDone: 0, additionalResource: false, repetition: false, language: false,
            prayersDone: 0, zikrDone: false, tahajjudDone: false, nafsControl: false, sleepOnTime: false,
            schedule: "", prohibitions: "", energy: 5, mood: 5, focus: 5, reflection: "", score: 0, qazoDone: false,
            tomorrowPlans: ["", "", "", "", ""]
        };

        function App() {
            const [view, setView] = useState('journal');
            const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
            const [dayNumber, setDayNumber] = useState(1);
            const [mode, setMode] = useState('stable');
            const [streak, setStreak] = useState(0);
            
            const [goals, setGoals] = useState(defaultGoalsData);
            const [settings, setSettings] = useState(defaultSettingsData);
            const [data, setData] = useState(defaultDailyData);
            
            const [showSettings, setShowSettings] = useState(false);
            const [showWeeklyReview, setShowWeeklyReview] = useState(false);
            const [showRewardModal, setShowRewardModal] = useState(false);
            const [rewardType, setRewardType] = useState('');
            const [showPunishmentModal, setShowPunishmentModal] = useState(false);
            const [showQazoModal, setShowQazoModal] = useState(false);

            const [aiAdvice, setAiAdvice] = useState('');
            const [aiMessages, setAiMessages] = useState([]);
            const [aiInput, setAiInput] = useState("");
            const [loadingAi, setLoadingAi] = useState(false);
            const [showAiModal, setShowAiModal] = useState(false);
            const chatEndRef = useRef(null);
            const [weeklyAiAdvice, setWeeklyAiAdvice] = useState('');

            // --- INITIALIZATION ---
            useEffect(() => {
                const savedGoals = localStorage.getItem('journal_goals');
                const savedSettings = localStorage.getItem('journal_settings');
                const savedStreak = localStorage.getItem('journal_streak');
                if (savedGoals) setGoals(JSON.parse(savedGoals));
                if (savedSettings) setSettings(JSON.parse(savedSettings));
                if (savedStreak) setStreak(parseInt(savedStreak));
                
                const startStr = localStorage.getItem('journal_start_date');
                if (!startStr) localStorage.setItem('journal_start_date', new Date().toISOString());
                
                loadDataForDate(selectedDate);
                if (Notification.permission !== "granted" && Notification.permission !== "denied") Notification.requestPermission();
            }, []);

            useEffect(() => {
                loadDataForDate(selectedDate);
                const startStr = localStorage.getItem('journal_start_date');
                if(startStr) {
                    const start = new Date(startStr);
                    const current = new Date(selectedDate);
                    const diffTime = current - start;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                    setDayNumber(diffDays > 0 ? diffDays : 1);
                }
            }, [selectedDate]);

            useEffect(() => {
                if (showAiModal && chatEndRef.current) chatEndRef.current.scrollIntoView({ behavior: "smooth" });
            }, [aiMessages, showAiModal]);

            // --- NOTIFICATION ---
            useEffect(() => {
                const checkTime = () => {
                    const now = new Date();
                    if (settings.enableNotifications && now.getHours() === 23 && now.getMinutes() === 0 && now.getSeconds() < 10) {
                        sendNotification("Уйқу вақти!", "Доктор, соат 23:00 бўлди. Режимга риоя қилинг.");
                    }
                };
                const interval = setInterval(checkTime, 10000);
                return () => clearInterval(interval);
            }, [settings.enableNotifications]);

            const sendNotification = (title, body) => {
                if (!("Notification" in window)) alert(title + "\n" + body);
                else if (Notification.permission === "granted") new Notification(title, { body });
                else alert(title + "\n" + body); 
            };

            const loadDataForDate = (dateStr) => {
                const savedData = localStorage.getItem(`journal_${dateStr}`);
                if (savedData) {
                    const parsed = JSON.parse(savedData);
                    if (!parsed.tomorrowPlans) parsed.tomorrowPlans = ["", "", "", "", ""];
                    setData(parsed);
                } else {
                    const d = new Date(dateStr); d.setDate(d.getDate() - 1);
                    const prevDateStr = d.toISOString().split('T')[0];
                    const prevDataJSON = localStorage.getItem(`journal_${prevDateStr}`);
                    let initialSchedule = "";
                    if (prevDataJSON) {
                        const prevData = JSON.parse(prevDataJSON);
                        if (prevData.tomorrowPlans && Array.isArray(prevData.tomorrowPlans)) {
                            const carriedOver = prevData.tomorrowPlans.filter(p => p.trim() !== "").map(p => `• ${p}`).join('\n');
                            if (carriedOver) initialSchedule = "Кечадан қолган муҳим вазифалар:\n" + carriedOver;
                        }
                    }
                    setData({ ...defaultDailyData, schedule: initialSchedule });
                    setAiMessages([]);
                }
            };

            const calculateScore = (d, g) => {
                const faGoal = g.firstAid || 1; const uwGoal = g.uWorld || 1; const akGoal = g.anki || 1;
                const ac = (Math.min(d.firstAidDone, faGoal)/faGoal)*10 + (Math.min(d.uWorldDone, uwGoal)/uwGoal)*10 + (Math.min(d.ankiDone, akGoal)/akGoal)*10 +
                           (d.additionalResource?5:0) + (d.repetition?5:0) + (d.language?5:0) + ((d.schedule && d.schedule.length>5)?5:0);
                const sp = (d.prayersDone/5)*20 + (d.zikrDone?5:0) + (d.tahajjudDone?5:0) + (d.nafsControl?10:0) + (d.sleepOnTime?5:0) + ((d.prohibitions && d.prohibitions.length>2)?5:0);
                return Math.round(ac + sp);
            };
            const currentScore = calculateScore(data, goals);

            useEffect(() => {
                if (currentScore < 50) setMode('critical'); else if (currentScore < 80) setMode('stable'); else setMode('legend');
                const newData = { ...data, score: currentScore };
                if (JSON.stringify(newData) !== localStorage.getItem(`journal_${selectedDate}`)) {
                    localStorage.setItem(`journal_${selectedDate}`, JSON.stringify(newData));
                }
                localStorage.setItem('journal_goals', JSON.stringify(goals));
                localStorage.setItem('journal_settings', JSON.stringify(settings));
            }, [data, goals, settings, selectedDate, currentScore]);

            const updateTask = (field, value) => setData(prev => ({ ...prev, [field]: value }));
            const getTheme = () => styles[mode];
            const getCardTheme = () => mode === 'critical' ? styles.cardCritical : mode === 'legend' ? styles.cardLegend : styles.cardStable;
            const getInputTheme = () => mode === 'critical' ? styles.inputCritical : mode === 'legend' ? styles.inputLegend : styles.inputStable;
            const currentQuote = dailyQuotes[(dayNumber - 1) % dailyQuotes.length] || dailyQuotes[0];

            // --- AI ---
            const initAiChat = async () => {
                if (!settings.apiKey) { alert("Илтимос, Созламалар бўлимига API калитни киритинг."); setShowSettings(true); return; }
                setShowAiModal(true);
                if (aiMessages.length === 0) {
                    const prompt = `Сиз тиббиёт талабаси учун 'AI Мураббий'сиз. Жавоб Ўзбек тилида, КИРИЛЛ алифбосида бўлсин.
                    Маълумотлар: Сана: ${selectedDate}, Натижа: ${currentScore}%, Таҳлил: "${data.reflection}".
                    Қисқа хулоса ва мотивация беринг. Кейин "Саволларинг борми?" деб сўранг.`;
                    setLoadingAi(true);
                    try {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${settings.apiKey}`, {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                        });
                        const result = await response.json();
                        const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "Алоқа йўқ.";
                        setAiMessages([{ role: 'model', text: text }]);
                    } catch (err) { setAiMessages([{ role: 'model', text: "Хатолик." }]); }
                    finally { setLoadingAi(false); }
                }
            };

            const sendAiMessage = async () => {
                if (!aiInput.trim()) return;
                const userMsg = aiInput;
                setAiMessages(prev => [...prev, { role: 'user', text: userMsg }]);
                setAiInput("");
                setLoadingAi(true);
                const context = aiMessages.slice(-5).map(m => `${m.role === 'user' ? 'Men' : 'Murabbiy'}: ${m.text}`).join('\n');
                const fullPrompt = `Суҳбат тарихи:\n${context}\n\nМенинг саволим: ${userMsg}\n(Жавоб қисқа ва ўзбек тилида кириллчада бўлсин)`;
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${settings.apiKey}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: fullPrompt }] }] })
                    });
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "Тушунмадим.";
                    setAiMessages(prev => [...prev, { role: 'model', text: text }]);
                } catch (err) { setAiMessages(prev => [...prev, { role: 'model', text: "Хатолик." }]); } 
                finally { setLoadingAi(false); }
            };

            const handleGetWeeklyAiAdvice = async (avg, stats) => {
                if (!settings.apiKey) { alert("AI ишлаши учун Созламалар бўлимига API Key киритинг."); return; }
                setLoadingAi(true);
                try {
                    const prompt = `Сиз 'AI Мураббий'сиз. Жавоб Ўзбек тилида, КИРИЛЛ алифбосида. Ҳафталик ҳисобот: Ўртача балл: ${avg}%, Намозлар: ${stats.prayers}/35, Нафс назорати: ${stats.nafs}/7. Келаси ҳафта учун стратегик маслаҳат беринг.`;
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${settings.apiKey}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "Хатолик.";
                    setWeeklyAiAdvice(text);
                } catch (error) { setWeeklyAiAdvice("Интернет ёки API калитда хатолик."); } 
                finally { setLoadingAi(false); }
            };

            const handleDayComplete = () => {
                if (data.prayersDone < 5) setShowQazoModal(true);
                else finalizeDay();
            };

            const finalizeDay = () => {
                if (currentScore < 50) { setShowPunishmentModal(true); setStreak(0); localStorage.setItem('journal_streak', '0'); return; }
                if (currentScore >= 80) {
                    const newStreak = streak + 1; setStreak(newStreak); localStorage.setItem('journal_streak', newStreak.toString());
                    if (newStreak % 3 === 0) { setRewardType('small'); setShowRewardModal(true); } 
                    else { alert("Баракалла! Афсонавий натижа!"); }
                } else { alert("Кун якунланди."); }
            };

            const handleQazoResponse = (isDone) => {
                setShowQazoModal(false);
                if (isDone) updateTask('qazoDone', true);
                finalizeDay();
            };

            const handleExport = () => {
                const allData = {};
                for(let i=0; i<localStorage.length; i++) { const key = localStorage.key(i); if(key.startsWith('journal_')) allData[key] = localStorage.getItem(key); }
                const blob = new Blob([JSON.stringify(allData)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `backup.json`; a.click();
            };
            const handleImport = (e) => {
                const file = e.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => { try { const imported = JSON.parse(e.target.result); Object.keys(imported).forEach(key => localStorage.setItem(key, imported[key])); alert("Тикланди!"); window.location.reload(); } catch(err) { alert("Хатолик"); } };
                reader.readAsText(file);
            };

            const CalendarView = () => {
               const [currentMonth, setCurrentMonth] = useState(new Date(selectedDate));
               const daysInMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0).getDate();
               const firstDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1).getDay();
               const days = [];
               for (let i = 0; i < (firstDay === 0 ? 6 : firstDay - 1); i++) days.push(<div key={`empty-${i}`} className="h-14"></div>);
               for (let d = 1; d <= daysInMonth; d++) {
                   const dateStr = `${currentMonth.getFullYear()}-${String(currentMonth.getMonth() + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                   const saved = localStorage.getItem(`journal_${dateStr}`);
                   const parsed = saved ? JSON.parse(saved) : null;
                   const score = parsed ? parsed.score : null;
                   let bgClass = "bg-gray-100 text-gray-400";
                   if (score !== null) { if (score < 50) bgClass = "bg-red-100 text-red-700 border border-red-200"; else if (score < 80) bgClass = "bg-blue-100 text-blue-700 border border-blue-200"; else bgClass = "bg-amber-100 text-amber-700 border border-amber-300 font-bold"; }
                   if (dateStr === selectedDate) bgClass += " ring-2 ring-offset-2 ring-slate-800";
                   days.push(<button key={d} onClick={() => { setSelectedDate(dateStr); setView('journal'); }} className={`h-14 rounded-xl flex flex-col items-center justify-center text-sm transition-all active:scale-95 ${bgClass}`}><span>{d}</span>{score !== null && <span className="text-[10px]">{score}%</span>}</button>);
               }
               return (
                   <div className="slide-in">
                       <div className="flex items-center justify-between mb-6"><button onClick={() => setCurrentMonth(new Date(currentMonth.setMonth(currentMonth.getMonth() - 1)))} className="p-2 bg-gray-100 rounded-full"><Icon name="chevron-left"/></button><h2 className="text-xl font-bold uppercase">{currentMonth.toLocaleString('ru-RU', { month: 'long', year: 'numeric' })}</h2><button onClick={() => setCurrentMonth(new Date(currentMonth.setMonth(currentMonth.getMonth() + 1)))} className="p-2 bg-gray-100 rounded-full"><Icon name="chevron-right"/></button></div>
                       <div className="grid grid-cols-7 gap-1 mb-2 text-center text-xs font-bold text-gray-400 uppercase"><span>Ду</span><span>Се</span><span>Чо</span><span>Па</span><span>Жу</span><span>Ша</span><span>Як</span></div>
                       <div className="grid grid-cols-7 gap-2">{days}</div>
                   </div>
               );
            };

            const WeeklyReview = () => {
                const stats = { prayers: 0, nafs: 0, scoreAvg: 0, count: 0 };
                for(let i=0; i<7; i++) {
                    const d = new Date(selectedDate); d.setDate(d.getDate() - i);
                    const s = localStorage.getItem(`journal_${d.toISOString().split('T')[0]}`);
                    if(s) { const p = JSON.parse(s); stats.prayers += p.prayersDone || 0; if(p.nafsControl) stats.nafs++; stats.scoreAvg += p.score || 0; stats.count++; }
                }
                const avg = stats.count ? Math.round(stats.scoreAvg / stats.count) : 0;
                const isBigReward = avg >= 90;
                return (
                    <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4 animate-in fade-in">
                        <div className="bg-white rounded-2xl p-6 w-full max-w-md max-h-[90vh] overflow-y-auto relative shadow-2xl">
                            {isBigReward && <div className="confetti absolute inset-0 pointer-events-none"></div>}
                            <div className="flex justify-between items-center mb-4"><h2 className="text-xl font-bold flex items-center text-indigo-700"><Icon name="layers" className="mr-2"/> Ҳафталик Таҳлил</h2><button onClick={() => setShowWeeklyReview(false)} className="bg-gray-100 p-2 rounded-full hover:bg-gray-200"><Icon name="x" size={20}/></button></div>
                            {isBigReward ? (<div className="bg-amber-100 border-l-4 border-amber-500 text-amber-700 p-4 mb-4 rounded animate-bounce-custom"><p className="font-bold">🎉 ТАБРИКЛАЙМИЗ! КАТТА МУКОФОТ!</p><p className="text-sm">Натижа: {avg}%. Мукофот:</p><p className="font-bold mt-2 text-lg">🎁 {settings.bigReward}</p></div>) : (<div className="bg-slate-50 border border-slate-200 p-3 mb-4 rounded-xl text-center"><p className="text-xs text-slate-500 mb-1">Катта мукофотгача (90%):</p><div className="w-full bg-gray-200 rounded-full h-2"><div className="bg-indigo-500 h-2 rounded-full" style={{width: `${avg}%`}}></div></div><p className="text-xs font-bold mt-1 text-indigo-600">{avg}%</p></div>)}
                            <div className="grid grid-cols-3 gap-3 mb-6"><div className="bg-blue-50 p-3 rounded-xl text-center"><div className="text-[10px] text-blue-400 uppercase font-bold">Ўртача</div><div className="text-2xl font-black text-blue-700">{avg}%</div></div><div className="bg-emerald-50 p-3 rounded-xl text-center"><div className="text-[10px] text-emerald-400 uppercase font-bold">Намоз</div><div className="text-2xl font-black text-emerald-700">{stats.prayers}<span className="text-sm text-emerald-400">/35</span></div></div><div className="bg-rose-50 p-3 rounded-xl text-center"><div className="text-[10px] text-rose-400 uppercase font-bold">Нафс</div><div className="text-2xl font-black text-rose-700">{stats.nafs}<span className="text-sm text-rose-400">/7</span></div></div></div>
                            <div className="mb-6"><button onClick={() => handleGetWeeklyAiAdvice(avg, stats)} className="w-full bg-indigo-100 text-indigo-700 py-3 rounded-xl font-bold flex items-center justify-center hover:bg-indigo-200 transition mb-3"><Icon name="sparkles" className="mr-2"/> Ҳафталик AI Таҳлил</button>{weeklyAiAdvice && (<div className="bg-indigo-50 p-4 rounded-xl text-sm text-slate-700 border border-indigo-100 ai-response"><div style={{whiteSpace: 'pre-wrap'}}>{weeklyAiAdvice}</div></div>)}{loadingAi && !weeklyAiAdvice && <p className="text-center text-xs text-gray-400 animate-pulse">Таҳлил қилинмоқда...</p>}</div>
                            <button onClick={() => setShowWeeklyReview(false)} className="w-full bg-slate-800 text-white py-3 rounded-xl font-bold mt-4 hover:bg-slate-900 transition">Ёпиш</button>
                        </div>
                    </div>
                );
            };

            return (
                <div className={`min-h-screen pb-24 font-sans ${getTheme()} transition-colors duration-500`}>
                    {view === 'journal' && (
                    <header className="p-6 pt-10 pb-4 relative overflow-hidden">
                        <div className="flex justify-between items-start z-10 relative">
                            <div className="flex-1 mr-4"><div className="flex items-center space-x-2 mb-1"><span className="text-xs font-bold uppercase tracking-widest opacity-60">V16 • {dayNumber}-Кун</span><span className="text-[10px] px-2 py-0.5 rounded bg-black/10 font-bold opacity-70">{selectedDate}</span></div><h1 className="text-lg font-bold italic leading-tight opacity-90">"{currentQuote}"</h1></div>
                            <div className={`flex flex-col items-center p-3 rounded-2xl border backdrop-blur-sm ${mode === 'legend' ? 'bg-amber-100/20 border-amber-400' : 'bg-white/10 border-current'}`}><div className="flex items-center space-x-1"><Icon name="flame" size={20} className={streak > 0 ? "text-orange-500 animate-pulse-custom" : "text-gray-400"} /><span className="font-bold text-xl">{streak}</span></div></div>
                        </div>
                        <div className="mt-6 relative"><div className="flex justify-between items-end mb-2"><span className="text-sm font-bold opacity-80">{mode === 'critical' ? '💀 ХАВФ' : mode === 'stable' ? '🏥 СТАБИЛ' : '🏆 АФСОНА'}</span><span className="text-2xl font-black">{currentScore}%</span></div><div className="w-full bg-black/10 rounded-full h-4 overflow-hidden"><div className={`h-full transition-all duration-300 ease-out relative ${mode === 'critical' ? 'bg-red-600' : mode === 'legend' ? 'bg-gradient-to-r from-emerald-400 to-amber-400' : 'bg-blue-500'}`} style={{ width: `${currentScore}%` }}></div></div></div>
                    </header>
                    )}

                    <div className={`px-5 space-y-6 z-10 relative ${view === 'journal' ? 'pt-2' : 'pt-12'}`}>
                        {view === 'calendar' && <CalendarView />}
                        {view === 'stats' && <div className="slide-in"><h2 className="text-2xl font-bold mb-4">Натижалар</h2><div className="p-4 bg-white rounded-2xl border shadow-sm mb-4"><h3 className="font-bold mb-2">Ҳафталик Ҳисобот</h3><p className="text-sm text-gray-500 mb-4">Ҳафталик натижа, AI таҳлил ва мукофотлар.</p><button onClick={() => setShowWeeklyReview(true)} className="w-full bg-blue-600 text-white py-2 rounded-lg font-bold hover:bg-blue-700 transition">Ҳисоботни очиш</button></div></div>}

                        {view === 'journal' && (
                        <div className="slide-in space-y-6">
                            <section className={`p-5 rounded-2xl border ${getCardTheme()}`}>
                                <h3 className="flex items-center font-bold mb-4 opacity-80"><Icon name="calendar" size={18} className="mr-2"/> Кун Режаси</h3>
                                <div className="space-y-4"><textarea value={data.schedule} onChange={(e)=>updateTask('schedule', e.target.value)} className={`w-full p-2 rounded-lg border text-sm h-20 ${getInputTheme()}`} placeholder="08:00 - ..." /><div className="flex items-start space-x-2"><Icon name="ban" size={18} className="text-red-500 mt-1"/><input value={data.prohibitions} onChange={(e)=>updateTask('prohibitions', e.target.value)} className={`w-full p-2 rounded-lg border text-sm ${getInputTheme()}`} placeholder="Тақиқлар..." /></div></div>
                            </section>
                            <section className={`p-5 rounded-2xl border ${getCardTheme()}`}>
                                <h3 className="flex items-center font-bold mb-4 opacity-80"><Icon name="book-open" size={18} className="mr-2"/> Академик Жанг</h3>
                                <div className="space-y-4">
                                    <div><div className="flex justify-between text-xs font-bold mb-1"><span>First Aid ({goals.firstAid})</span><span className="opacity-60">{data.firstAidDone}</span></div><input type="range" max={goals.firstAid + 10} value={data.firstAidDone} onChange={(e)=>updateTask('firstAidDone', parseInt(e.target.value))} className="w-full h-2 rounded-lg bg-gray-200 accent-emerald-600 appearance-none"/></div>
                                    <div className="grid grid-cols-2 gap-3"><div className={`p-2 rounded-xl border flex flex-col items-center justify-center ${getInputTheme()}`}><span className="text-[10px] font-bold opacity-60">UWorld ({goals.uWorld})</span><div className="flex items-center space-x-2"><button onClick={()=>updateTask('uWorldDone', Math.max(0,data.uWorldDone-5))} className="p-1 font-bold">-</button><span className="text-xl font-bold">{data.uWorldDone}</span><button onClick={()=>updateTask('uWorldDone', data.uWorldDone+5)} className="p-1 font-bold text-emerald-500">+</button></div></div><div className={`p-2 rounded-xl border flex flex-col items-center justify-center ${getInputTheme()}`}><span className="text-[10px] font-bold opacity-60">Anki ({goals.anki})</span><div className="flex items-center space-x-2"><button onClick={()=>updateTask('ankiDone', Math.max(0,data.ankiDone-5))} className="p-1 font-bold">-</button><span className="text-xl font-bold">{data.ankiDone}</span><button onClick={()=>updateTask('ankiDone', data.ankiDone+5)} className="p-1 font-bold text-emerald-500">+</button></div></div></div>
                                    <div className="grid grid-cols-1 gap-2">
                                        <button onClick={()=>updateTask('language', !data.language)} className={`flex items-center p-3 rounded-xl border transition-all ${data.language?'bg-blue-500 text-white':'opacity-60 border-current'}`}><Icon name="globe" size={18} className="mr-3"/><span className="text-sm font-bold">Инглиз / Араб тили</span>{data.language && <Icon name="check-circle" size={16} className="ml-auto"/>}</button>
                                        <button onClick={()=>updateTask('repetition', !data.repetition)} className={`flex items-center p-3 rounded-xl border transition-all ${data.repetition?'bg-purple-500 text-white':'opacity-60 border-current'}`}><Icon name="refresh-cw" size={18} className="mr-3"/><span className="text-sm font-bold">Такрорлаш</span>{data.repetition && <Icon name="check-circle" size={16} className="ml-auto"/>}</button>
                                        <button onClick={()=>updateTask('additionalResource', !data.additionalResource)} className={`flex items-center p-3 rounded-xl border transition-all ${data.additionalResource?'bg-teal-500 text-white':'opacity-60 border-current'}`}><Icon name="plus-circle" size={18} className="mr-3"/><span className="text-sm font-bold">Қўшимча ресурс</span>{data.additionalResource && <Icon name="check-circle" size={16} className="ml-auto"/>}</button>
                                    </div>
                                </div>
                            </section>
                            <section className={`p-5 rounded-2xl border ${getCardTheme()}`}>
                                <h3 className="flex items-center font-bold mb-4 opacity-80"><Icon name="heart" size={18} className="mr-2"/> Руҳий Қалқон</h3>
                                <div className="grid grid-cols-2 gap-3">
                                    <button onClick={()=>updateTask('prayersDone', data.prayersDone >= 5 ? 0 : data.prayersDone+1)} className={`col-span-2 p-3 rounded-xl border flex items-center justify-between ${data.prayersDone===5?'bg-emerald-500 text-white':'opacity-60 border-current'}`}><span className="font-bold flex items-center"><Icon name="activity" size={18} className="mr-2"/> 5 Вақт Намоз</span><span className="text-xl font-bold">{data.prayersDone}/5</span></button>
                                    <button onClick={()=>updateTask('tahajjudDone', !data.tahajjudDone)} className={`p-3 rounded-xl border flex flex-col items-center justify-center ${data.tahajjudDone?'bg-indigo-600 text-white':'opacity-60 border-current'}`}><Icon name="moon" size={20} className="mb-1"/><span className="text-[10px] font-bold">Таҳажжуд</span></button>
                                    <button onClick={()=>updateTask('zikrDone', !data.zikrDone)} className={`p-3 rounded-xl border flex flex-col items-center justify-center ${data.zikrDone?'bg-cyan-600 text-white':'opacity-60 border-current'}`}><Icon name="message-circle" size={20} className="mb-1"/><span className="text-[10px] font-bold">Зикр</span></button>
                                    <button onClick={()=>updateTask('nafsControl', !data.nafsControl)} className={`p-3 rounded-xl border flex items-center justify-center space-x-2 ${data.nafsControl?'bg-rose-600 text-white':'text-red-400 border-red-200'}`}>{data.nafsControl?<Icon name="check-circle" size={18}/>:<Icon name="skull" size={18}/>}<span className="text-xs font-bold">N-Нафс</span></button>
                                    <button onClick={()=>updateTask('sleepOnTime', !data.sleepOnTime)} className={`p-3 rounded-xl border flex items-center justify-center space-x-2 ${data.sleepOnTime?'bg-indigo-900 text-white':'text-indigo-900 border-indigo-200'}`}><Icon name="clock" size={18}/><span className="text-xs font-bold">23:00 Уйқу</span></button>
                                </div>
                            </section>
                            <section className={`p-5 rounded-2xl border ${getCardTheme()}`}>
                                <h3 className="flex items-center font-bold mb-4 opacity-80"><Icon name="bar-chart-2" size={18} className="mr-2"/> Биоритмлар</h3>
                                <div className="space-y-3">
                                    <div className="flex items-center justify-between"><span className="text-xs font-bold w-16">⚡ Энергия</span><input type="range" min="1" max="10" value={data.energy} onChange={(e)=>updateTask('energy', e.target.value)} className="flex-1 h-2 rounded-lg bg-gray-200 accent-amber-500 appearance-none mx-2"/><span className="text-xs font-bold w-4 text-right">{data.energy}</span></div>
                                    <div className="flex items-center justify-between"><span className="text-xs font-bold w-16">😔 Кайфият</span><input type="range" min="1" max="10" value={data.mood} onChange={(e)=>updateTask('mood', e.target.value)} className="flex-1 h-2 rounded-lg bg-gray-200 accent-pink-500 appearance-none mx-2"/><span className="text-xs font-bold w-4 text-right">{data.mood}</span></div>
                                    <div className="flex items-center justify-between"><span className="text-xs font-bold w-16">🎯 Диққат</span><input type="range" min="1" max="10" value={data.focus} onChange={(e)=>updateTask('focus', e.target.value)} className="flex-1 h-2 rounded-lg bg-gray-200 accent-blue-500 appearance-none mx-2"/><span className="text-xs font-bold w-4 text-right">{data.focus}</span></div>
                                </div>
                            </section>
                            <section className={`p-5 rounded-2xl border ${getCardTheme()}`}>
                                <div className="flex justify-between items-center mb-4"><h3 className="flex items-center font-bold opacity-80"><Icon name="pen-tool" size={18} className="mr-2"/> Кунлик Таҳлил</h3><button onClick={initAiChat} className="bg-indigo-600 text-white text-[10px] px-3 py-1.5 rounded-full font-bold flex items-center shadow-md hover:bg-indigo-700 transition"><Icon name="sparkles" size={14} className="mr-1" /> AI Мураббий</button></div>
                                <textarea className={`w-full p-3 rounded-xl border text-sm min-h-[100px] ${getInputTheme()}`} placeholder="1. Қаерда ютдим? 2. Нафс қаерда ютди?" value={data.reflection} onChange={(e)=>updateTask('reflection', e.target.value)} />
                            </section>
                            <section className={`p-5 rounded-2xl border ${getCardTheme()}`}>
                                <h3 className="flex items-center font-bold mb-4 opacity-80"><Icon name="list-todo" size={18} className="mr-2"/> Эртанги кун учун 5 та муҳим вазифа</h3>
                                <div className="space-y-2">{data.tomorrowPlans.map((plan, idx) => (<div key={idx} className="flex items-center"><span className="text-xs font-bold w-4 mr-2 opacity-50">{idx + 1}.</span><input type="text" className={`w-full p-3 rounded-xl border text-sm ${getInputTheme()} focus:ring-2 focus:ring-opacity-50 focus:outline-none transition-all`} placeholder="Муҳим вазифа..." value={plan} onChange={(e) => { const newPlans = [...data.tomorrowPlans]; newPlans[idx] = e.target.value; updateTask('tomorrowPlans', newPlans); }} /></div>))}</div>
                            </section>
                            <div className="pb-10"><button onClick={handleDayComplete} className={`w-full py-4 rounded-2xl font-bold shadow-xl flex items-center justify-center space-x-2 active:scale-95 ${mode==='critical'?'bg-red-600 text-white':mode==='legend'?'bg-amber-500 text-white':'bg-slate-800 text-white'}`}><Icon name="save" size={20} /><span>Сақлаш</span></button></div>
                        </div>
                        )}
                    </div>

                    <nav className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 pb-safe z-50"><div className="flex justify-around items-center h-16 max-w-md mx-auto"><button onClick={() => setView('journal')} className={`flex flex-col items-center justify-center w-1/3 h-full ${view === 'journal' ? 'text-slate-900' : 'text-gray-400'}`}><Icon name="home" size={24} /><span className="text-[10px] font-bold mt-1">Бугун</span></button><button onClick={() => setView('calendar')} className={`flex flex-col items-center justify-center w-1/3 h-full ${view === 'calendar' ? 'text-slate-900' : 'text-gray-400'}`}><Icon name="history" size={24} /><span className="text-[10px] font-bold mt-1">Тарих</span></button><button onClick={() => setView('stats')} className={`flex flex-col items-center justify-center w-1/3 h-full ${view === 'stats' ? 'text-slate-900' : 'text-gray-400'}`}><Icon name="bar-chart-2" size={24} /><span className="text-[10px] font-bold mt-1">Таҳлил</span></button></div></nav>

                    {showAiModal && (<div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4 animate-in fade-in"><div className="bg-white rounded-2xl w-full max-w-md h-[80vh] flex flex-col shadow-2xl overflow-hidden"><div className="p-4 bg-indigo-700 text-white flex justify-between items-center shadow-md"><h2 className="font-bold flex items-center"><Icon name="sparkles" className="mr-2"/> AI Мураббий</h2><button onClick={() => setShowAiModal(false)}><Icon name="x" size={20}/></button></div><div className="flex-1 p-4 overflow-y-auto bg-gray-50 space-y-3">{aiMessages.map((msg, idx) => (<div key={idx} className={msg.role === 'user' ? 'chat-bubble-user' : 'chat-bubble-ai'}><div style={{whiteSpace: 'pre-wrap'}}>{msg.text}</div></div>))}{loadingAi && <div className="text-center text-xs text-gray-400 animate-pulse">Ёзилмоқда...</div>}<div ref={chatEndRef}></div></div><div className="p-3 bg-white border-t flex items-center"><input type="text" className="flex-1 border rounded-full px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Савол беринг..." value={aiInput} onChange={(e) => setAiInput(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && sendAiMessage()} /><button onClick={sendAiMessage} className="ml-2 bg-indigo-600 text-white p-2 rounded-full hover:bg-indigo-700 disabled:opacity-50" disabled={loadingAi}><Icon name="send" size={18}/></button></div></div></div>)}

                    {showQazoModal && (<div className="fixed inset-0 bg-black/70 backdrop-blur-sm z-[90] flex items-center justify-center p-4 animate-in fade-in"><div className="bg-white rounded-2xl p-6 w-full max-w-sm text-center shadow-2xl border-2 border-indigo-100"><div className="w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4"><Icon name="moon" size={32} className="text-indigo-600" /></div><h2 className="text-xl font-bold text-slate-800 mb-2">Намоз қазоси</h2><p className="text-sm text-slate-600 mb-6">Сиз бугун 5 маҳал намозни тўлиқ ўқимадингиз. <br/><strong>Қазосини ўқидингизми?</strong></p><div className="grid grid-cols-2 gap-3"><button onClick={() => handleQazoResponse(false)} className="w-full bg-gray-200 text-gray-700 py-3 rounded-xl font-bold hover:bg-gray-300 flex items-center justify-center"><Icon name="x" size={16} className="mr-2"/> Йўқ</button><button onClick={() => handleQazoResponse(true)} className="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 flex items-center justify-center"><Icon name="check" size={16} className="mr-2"/> Ҳа</button></div></div></div>)}

                    {showRewardModal && (<div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-in fade-in"><div className="bg-white rounded-2xl p-6 w-full max-w-sm text-center relative overflow-hidden"><div className="confetti absolute inset-0 pointer-events-none"></div><div className="w-16 h-16 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-4"><Icon name="gift" size={32} className="text-amber-500 animate-bounce-custom" /></div><h2 className="text-xl font-bold text-slate-800 mb-2">ТАБРИКЛАЙМИЗ!</h2><div className="bg-amber-50 border border-amber-200 p-4 rounded-xl mb-4"><p className="text-xs uppercase font-bold text-amber-400 mb-1">{rewardType === 'small' ? 'КИЧИК МУКОФОТ' : 'КАТТА МУКОФОТ'}</p><p className="font-bold text-lg text-amber-700">{rewardType === 'small' ? settings.smallReward : settings.bigReward}</p></div><button onClick={() => setShowRewardModal(false)} className="w-full bg-amber-500 text-white py-3 rounded-xl font-bold">Қабул қилдим</button></div></div>)}

                    {showPunishmentModal && (<div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-in fade-in"><div className="bg-gray-900 rounded-2xl p-6 w-full max-w-sm text-center border border-red-500 shadow-[0_0_30px_rgba(220,38,38,0.5)]"><div className="w-16 h-16 bg-red-900/50 rounded-full flex items-center justify-center mx-auto mb-4"><Icon name="alert-triangle" size={32} className="text-red-500" /></div><h2 className="text-xl font-bold text-white mb-2">ДИҚҚАТ! ЖАЗО ВАҚТИ</h2><p className="text-sm text-red-300 mb-4">Бугунги режа бажарилмади (50% дан кам).</p><div className="bg-red-900/30 border border-red-800 p-4 rounded-xl mb-4"><p className="text-xs uppercase font-bold text-red-400 mb-1">БАЖАРИШИНГИЗ ШАРТ:</p><p className="font-bold text-lg text-red-200">{settings.punishment}</p></div><button onClick={() => setShowPunishmentModal(false)} className="w-full bg-red-600 text-white py-3 rounded-xl font-bold">Бажараман</button></div></div>)}

                    {showSettings && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-[90] flex items-center justify-center p-4 animate-in fade-in">
                            <div className="bg-white rounded-2xl p-6 w-full max-w-sm text-slate-800 max-h-[90vh] overflow-y-auto shadow-2xl">
                                <h2 className="font-bold mb-4 flex items-center text-lg"><Icon name="settings" className="mr-2"/> Созламалар</h2>
                                <div className="mb-6 border-b pb-4">
                                    <label className="text-xs font-bold uppercase block mb-1 text-indigo-600">Google Gemini API Key</label>
                                    <input type="text" className="w-full border border-indigo-200 rounded p-2 text-sm bg-indigo-50" placeholder="AI ишлаши учун калитни қўйинг" value={settings.apiKey} onChange={e=>setSettings({...settings, apiKey: e.target.value})}/>
                                    <div className="mt-2 flex items-center"><input type="checkbox" className="mr-2" checked={settings.enableNotifications} onChange={e=>setSettings({...settings, enableNotifications: e.target.checked})}/><span className="text-sm">Уведомлениелар (23:00 да)</span></div>
                                </div>
                                <div className="mb-6 border-b pb-4">
                                    <h3 className="text-xs font-bold uppercase text-blue-600 mb-3">Кунлик Мақсадлар</h3>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div><label className="text-[10px] font-bold block mb-1">First Aid</label><input type="number" className="w-full border rounded p-2 text-sm" value={goals.firstAid} onChange={e=>setGoals({...goals, firstAid: parseInt(e.target.value)||0})}/></div>
                                        <div><label className="text-[10px] font-bold block mb-1">UWorld</label><input type="number" className="w-full border rounded p-2 text-sm" value={goals.uWorld} onChange={e=>setGoals({...goals, uWorld: parseInt(e.target.value)||0})}/></div>
                                        <div><label className="text-[10px] font-bold block mb-1">Anki</label><input type="number" className="w-full border rounded p-2 text-sm" value={goals.anki} onChange={e=>setGoals({...goals, anki: parseInt(e.target.value)||0})}/></div>
                                    </div>
                                </div>
                                <div className="mb-6 border-b pb-4">
                                    <h3 className="text-xs font-bold uppercase text-amber-600 mb-3">Мукофот ва Жазо</h3>
                                    <div className="space-y-3">
                                        <div><label className="text-[10px] font-bold block mb-1">Кичик Мукофот</label><input type="text" className="w-full border rounded p-2 text-sm" value={settings.smallReward} onChange={e=>setSettings({...settings, smallReward: e.target.value})}/></div>
                                        <div><label className="text-[10px] font-bold block mb-1">Катта Мукофот</label><input type="text" className="w-full border rounded p-2 text-sm" value={settings.bigReward} onChange={e=>setSettings({...settings, bigReward: e.target.value})}/></div>
                                        <div><label className="text-[10px] font-bold block mb-1 text-red-600">Жазо</label><input type="text" className="w-full border border-red-200 rounded p-2 text-sm bg-red-50" value={settings.punishment} onChange={e=>setSettings({...settings, punishment: e.target.value})}/></div>
                                    </div>
                                </div>
                                <div className="mt-4 pt-4 border-t">
                                    <button onClick={handleExport} className="w-full mb-2 bg-gray-100 text-gray-700 py-2 rounded-lg font-bold flex items-center justify-center"><Icon name="download" size={16} className="mr-2"/> Скачать (Backup)</button>
                                    <label className="w-full bg-gray-100 text-gray-700 py-2 rounded-lg font-bold flex items-center justify-center cursor-pointer"><Icon name="upload" size={16} className="mr-2"/> Юклаш (Restore)<input type="file" onChange={handleImport} className="hidden" accept=".json"/></label>
                                </div>
                                <button onClick={() => setShowSettings(false)} className="w-full bg-slate-800 text-white py-3 rounded-xl font-bold mt-4 flex items-center justify-center"><Icon name="check" size={18} className="mr-2"/> Сақлаш ва Ёпиш</button>
                            </div>
                        </div>
                    )}
                    
                    <button onClick={() => setShowSettings(true)} className="fixed bottom-20 right-6 bg-white p-3 rounded-full shadow-lg border text-slate-600 z-[80] active:scale-90"><Icon name="settings" size={24}/></button>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
